In this section we will cover the basics of deploying an application with argocd using manifests in a git repository.

We will deploy the same coolstore application as previously, but this time we will do that using a GitOps approach.

=== Deploy the Application

A managed collection of manifests is known as an `Application` within Argo CD.
Therefore, you must define it as such using an
link:https://argo-cd.readthedocs.io/en/stable/operator-manual/declarative-setup/#applications[Application
CR (CustomResource)^] in order to have Argo CD apply these manifests in your
cluster.

Let's review the `Application` manifest used to deploy this application (found link:https://github.com/AdvancedDevSecOpsWorkshop/workshop/blob/main/content/modules/ROOT/files/gitops/coolstore-gitops.yaml[here,window="_blank"])
and break this down a bit:

.link:https://github.com/AdvancedDevSecOpsWorkshop/workshop/blob/main/content/modules/ROOT/files/gitops/coolstore-gitops.yaml[coolstore-gitops.yaml,window="_blank"]
[source,yaml,subs="+macros,attributes+"]
----
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: coolstore-app
spec:
  destination:
    namespace: user1-cicd
    name: in-cluster <1>
  project: user1 <2>
  source: <3>
    path: content/modules/ROOT/files/module-01
    repoURL: https://github.com/AdvancedDevSecOpsWorkshop/workshop.git
    targetRevision: HEAD
  syncPolicy: <4>
    automated:
      prune: true
      selfHeal: true
----
<1> The destination server is API endpoint for the cluster where Argo CD is
  running -- in this case, using the locally-resolveable URL for the cluster
<2> Here you're installing the application in Argo CD's `default` project
  (`.spec.project`).
[NOTE]
Argo CD's concept of a `Project` is different than OpenShift's. Here you're
installing the application in Argo CD's `default` project (`.spec.project`).
*NOT* OpenShift's default project.
<3> The manifest repo, and the path within it where the YAML resides.
<4> The `syncPolicy` is set to `automated`. It will automatically prune
  resources that have been removed from the Git repo, but will not automatically
  correct resources that deviate from the definition stored in the repo, i.e
  manual changes made using `oc` or `kubectl` will not be "healed".

You will create an Application by slightly modifying the provided example inline
using the command below:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
sed 's/$USERNUM/%USERNUM%/' ~/workshop/content/modules/ROOT/files/gitops/coolstore-gitops.yaml | oc apply -n user%USERNUM%-argocd -f -
----

The newly created Application appears as a tile with the title `bgd-app` in the
Argo CD UI.

image::gitops-apps/coolstore-app.png[SampleApp]

Clicking on this tile takes you to the application details page. You may see it
as still progressing or fully synced.

image::gitops-apps/coolstore-app2.png[SampleApp]

At this point the application should be up and running. Verify that the
resources were created:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc get all -n user%USERNUM%-cicd
----

The output should list several things:

[.console-output]
[source,bash,subs="attributes+,+macros"]
----
NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/catalog-database    1/1     1            1           16m
deployment.apps/gateway-vertx       1/1     1            1           16m
deployment.apps/inventory-quarkus   1/1     1            1           16m
deployment.apps/nexus               1/1     1            1           26h
deployment.apps/sonarqube           1/1     1            1           26h

NAME                                           DESIRED   CURRENT   READY   AGE
replicaset.apps/catalog-database-57b4b4f4bc    1         1         1       16m
replicaset.apps/gateway-vertx-5f6b554664       1         1         1       16m
replicaset.apps/inventory-quarkus-64f5b79fc8   1         1         1       16m
replicaset.apps/nexus-85ffd9f685               1         1         1       26h
replicaset.apps/sonarqube-66c4694b89           1         1         1       26h

NAME                            COMPLETIONS   DURATION   AGE
job.batch/configure-nexus       1/1           79s        26h
job.batch/configure-sonarqube   1/1           2m10s      26h
----


**Extra Credit:** Do you know why you have a ReplicaSet?

Wait for the rollout of the new pods to happen in the deployment:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc rollout status deploy/inventory-quarkus -n user%USERNUM%-cicd
----

If it is successful, you can now visit the deployed application in the browser.

From the OpenShift web console, select *user%USERNUM%-cicd* Project from
drop-down menu, and use the _Topology_ view to find the link as you did with
the Argo CD console.

image::gitops-apps/coolstore-topology.png[coolstore App]

Alternatively, get the app Route from the CLI:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc get route gateway-vertx -n user%USERNUM%-cicd -o jsonpath='{"http://"}{.spec.host}{"\n"}'
----

WARNING: This route is only available via HTTP. If you try to visit via HTTPS,
you will get an _Application not available_ error. Do you know why that is?

=== Addressing Configuration Drift

Let's introduce a change in the application environment! Patch the live
Deployment manifest to change the color of the bubbles in the application from
blue to green:

[.console-input]
[source,bash,subs="attributes+,+macros"]

----
oc -n user%USERNUM%-cicd scale deploy inventory-quarkus --replicas=4 
----

You can see that the pods will start to get created, but instantly get deleted again. This is because OpenShift GitOps is automatically setting the replicas number to 1, as specified in the application manifest for the quarkus-inventory deployment.

You can set up Argo CD to automatically correct drift by setting the `selfHeal`
property of the `Application` manifest to do so. Using the example from link:#_deploy_the_application[above]:

[.console-input]
[source,yaml,subs="attributes+,+macros"]
----
# coolstore-gitops.yaml
...
spec:
  syncPolicy:
    automated:
      prune: true
      selfHeal: true # Set this to true
----

You can also manually sync your app via the Argo CD by:

* First clicking `SYNC`
* Then clicking `SYNCHRONIZE`

image::gitops-apps/coolstore-manual-sync.png[Manually Sync the application]

After the sync process is done, the Argo CD UI should mark the application as in
sync.

Or, as in our case, after the fact by running the following command:

[.console-input]
[source,bash,subs="attributes+,+macros"]
----
oc patch application/coolstore-app -n user%USERNUM%-argocd --type=merge -p='{"spec":{"syncPolicy":{"automated":{"prune":true,"selfHeal":true}}}}'
----